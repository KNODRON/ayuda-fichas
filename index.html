<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Radar Pasivo - DetecciÃ³n de Drones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
    }
    #map { height: 100vh; width: 100%; }

    #sidebar {
      width: 300px;
      height: 100vh;
      background: #e0f0e8;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      position: fixed;
      left: 0;
      top: 0;
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    #sidebar.hidden {
      transform: translateX(-100%);
    }
    #toggleSidebar {
      position: fixed;
      top: 10px;
      left: 310px;
      z-index: 1100;
      background: #2d5f3b;
      color: white;
      border: none;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 4px;
    }

    .deteccion {
      background: #fff;
      border-left: 4px solid #2c3e50;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .alerta {
      position: fixed;
      top: 20px;
      right: 20px;
      background: red;
      color: white;
      padding: 12px 20px;
      font-size: 20px;
      font-weight: bold;
      z-index: 2000;
      animation: parpadeo 1s infinite;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.4);
    }

    @keyframes parpadeo {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }

    .leaflet-control-layers {
      margin-top: 70px !important;
    }
  </style>
</head>
<body>

<div id="sidebar">
  <h3>ðŸ“‹ Detecciones</h3>
  <div id="listaDetecciones"></div>
</div>
<button id="toggleSidebar">Ocultar barra</button>

<div id="map"></div>
<div id="alerta" class="alerta" style="display:none;">DRON DETECTADO</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const radarLatLng = L.latLng(-33.447867318202256, -70.65718192524163);
  const torreEntel = [-33.44462269903805, -70.65603368514269];
  const map = L.map('map').setView(radarLatLng, 15);

  // Capas de mapa
  const capa1 = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
  const capa2 = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');

  capa1.addTo(map);
  L.control.layers({ "OpenStreetMap": capa1, "TopoMap": capa2 }).addTo(map);

  // Iconos
  const radarIcon = L.icon({ iconUrl: 'radarIcon.png', iconSize: [36, 36] });
  const dronIcon = L.icon({ iconUrl: 'dronIcon.png', iconSize: [30, 30] });

  // Radar
  L.marker(radarLatLng, { icon: radarIcon }).addTo(map).bindPopup("ðŸ“¡ Radar Pasivo");
  L.circle(radarLatLng, { radius: 1200, color: '#2ecc71', fillColor: '#2ecc71', fillOpacity: 0.2 }).addTo(map);

  // Conos (excepto hacia Torre Entel)
  const aperturaTP541 = 54;
  const radioTP541 = 1200;
  const angulos = [30, 120, 210, 300]; // Evitando Torre Entel

  function degToRad(deg) {
    return deg * (Math.PI / 180);
  }

  function generarHaz(latlng, angulo, apertura, radio) {
    const puntos = [latlng];
    const pasos = 20;
    const inicio = angulo - apertura / 2;
    const fin = angulo + apertura / 2;

    for (let i = 0; i <= pasos; i++) {
      const theta = degToRad(inicio + ((fin - inicio) * i) / pasos);
      const dx = radio * Math.sin(theta);
      const dy = -radio * Math.cos(theta);
      const destino = L.latLng(
        latlng.lat + (180 / Math.PI) * (dy / 6378137),
        latlng.lng + (180 / Math.PI) * (dx / 6378137) / Math.cos(latlng.lat * Math.PI / 180)
      );
      puntos.push(destino);
    }

    return puntos;
  }

  angulos.forEach((angulo) => {
    const haz = generarHaz(radarLatLng, angulo, aperturaTP541, radioTP541);
    L.polygon(haz, {
      color: "red",
      fillColor: "red",
      fillOpacity: 0.2,
      weight: 1,
      dashArray: "4"
    }).addTo(map);
  });

  // Zona ciega hacia torre Entel (entre 330Â° y 30Â°)
  const zonaCiega = generarHaz(radarLatLng, 0, 60, 1200);
  L.polygon(zonaCiega, {
    color: "gray",
    fillColor: "gray",
    fillOpacity: 0.15,
    weight: 1
  }).addTo(map).bindPopup("Zona ciega hacia Torre Entel");

  // Sidebar y alerta
  const alerta = document.getElementById("alerta");
  const listaDiv = document.getElementById("listaDetecciones");
  const toggleSidebar = document.getElementById("toggleSidebar");
  const sidebar = document.getElementById("sidebar");

  toggleSidebar.addEventListener("click", () => {
    sidebar.classList.toggle("hidden");
    toggleSidebar.innerText = sidebar.classList.contains("hidden") ? "Mostrar barra" : "Ocultar barra";
  });

  // Drones en movimiento
  const drones = [
    { nombre: "Dron 1", lat: radarLatLng.lat, lng: radarLatLng.lng, marker: null, ruta: "erratica", coordenadas: [] },
    { nombre: "Dron 2", lat: radarLatLng.lat + 0.002, lng: radarLatLng.lng - 0.002, marker: null, ruta: "erratica", coordenadas: [] },
    { nombre: "Dron 3", lat: radarLatLng.lat + 0.012, lng: radarLatLng.lng + 0.005, marker: null, ruta: "recta", coordenadas: [] }
  ];

  drones.forEach((dron, i) => {
    const m = L.marker([dron.lat, dron.lng], { icon: dronIcon })
      .addTo(map)
      .bindPopup(`ðŸ›¸ <b>${dron.nombre}</b><br>SimulaciÃ³n de dron enemigo`);
    dron.marker = m;

    const div = document.createElement("div");
    div.className = "deteccion";
    div.id = `info${i}`;
    listaDiv.appendChild(div);
  });

  function moverDrones() {
    drones.forEach((dron, i) => {
      if (dron.ruta === "erratica") {
        dron.lat += (Math.random() - 0.5) * 0.0003;
        dron.lng += (Math.random() - 0.5) * 0.0003;
      } else {
        if (dron.lat > radarLatLng.lat - 0.012) {
          dron.lat -= 0.0004;
          dron.lng -= 0.0001;
        }
      }

      dron.coordenadas.push([dron.lat, dron.lng]);
      if (dron.coordenadas.length > 1) {
        L.polyline(dron.coordenadas.slice(-2), { color: 'black', weight: 1 }).addTo(map);
      }

      dron.marker.setLatLng([dron.lat, dron.lng]);
      dron.marker.setPopupContent(`ðŸ›¸ <b>${dron.nombre}</b><br>Lat: ${dron.lat.toFixed(6)}<br>Lng: ${dron.lng.toFixed(6)}`);

      // Actualiza lista
      const info = document.getElementById(`info${i}`);
      info.innerHTML = `<span>${dron.nombre}</span>Lat: ${dron.lat.toFixed(6)}<br>Lng: ${dron.lng.toFixed(6)}`;

      // Alarma visual si entra al radio
      const distancia = map.distance(radarLatLng, [dron.lat, dron.lng]);
      if (distancia < 1200) {
        alerta.style.display = 'block';
      }
    });
  }

  setInterval(moverDrones, 1000);
</script>

</body>
</html>
